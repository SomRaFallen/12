<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Планировщик обучения</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --accent:#0c21ed;
    --ok:#059669; --danger:#dc2626; --border:#e6e9ef;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Arial;margin:18px;background:var(--bg);color:#100f0f}
  .wrap{max-width:1100px;margin:0 auto}
  .row{display:flex;gap:12px;align-items:center}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(11,17,32,0.04)}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{margin:0;font-size:20px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent)}
  input,select{padding:6px 8px;border:1px solid var(--border);border-radius:8px}
  .list{margin-top:12px}
  .topic{display:flex;gap:10px;align-items:center;border:1px solid var(--border);padding:10px;border-radius:10px;margin-bottom:8px;flex-wrap:wrap}
  .topic .title{flex:1}
  .small{font-size:13px;color:var(--muted)}
  .summary{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .stat{background:#fbfdff;padding:10px;border-radius:10px;border:1px solid var(--border);min-width:160px}
  .day-block{border:1px dashed var(--border);padding:10px;border-radius:8px;margin-top:12px;background:#fcfdff}
  .day-topic{display:flex;align-items:center;gap:8px;margin-top:6px}
  .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);margin-left:8px}
  .muted{color:var(--muted)}
  @media (max-width:720px){ .row{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
<div class="wrap">
  <header class="row">
    <div class="row" style="align-items:center;gap:10px">
      <!-- ЛОГО VSR -->
      <svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 48 48">
        <rect width="48" height="48" rx="12" fill="#1f22ef"/>
        <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central"
              font-family="Verdana, Geneva, sans-serif"
              font-weight="700"
              font-size="19" fill="white">VSR</text>
      </svg>
      <h1>Планировщик обучения</h1>
    </div>
    <div class="controls">
      <label><input id="uploadPlan" type="file" accept=".json" style="display:none">
        <button onclick="document.getElementById('uploadPlan').click()">Загрузить план (JSON)</button>
      </label>
      <button id="saveSessionBtn" class="ghost">Сохранить сессию (JSON)</button>
      <button id="loadSessionBtn" class="ghost">Загрузить сессию</button>
    </div>
  </header>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div style="flex:1;margin-right:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="planName" placeholder="Название плана" style="flex:1" />
          <select id="filterType">
            <option value="all">Все темы</option>
            <option value="internal">Внутренние</option>
            <option value="external">Внешние</option>
            <option value="remaining">Оставшиеся</option>
          </select>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="newTitle" placeholder="Название темы" style="flex:1" />
          <input id="newMinutes" placeholder="минут" style="width:90px" type="number" min="1" />
          <label class="small"><input id="newInternal" type="checkbox"> Внутренняя</label>
          <button id="addTopicBtn">Добавить тему</button>
        </div>

        <div class="list" id="topicsList" style="margin-top:12px"></div>
      </div>

      <div style="width:320px">
        <div class="card" style="padding:12px">
          <strong>Статистика</strong>
          <div class="summary">
            <div class="stat"><div class="small">Всего тем</div><div id="statCount">0</div></div>
            <div class="stat"><div class="small">Всего минут</div><div id="statMinutes">0</div></div>
            <div class="stat"><div class="small">Пройдено минут</div><div id="statDoneMin">0</div></div>
            <div class="stat"><div class="small">Процент</div><div id="statPct">0%</div></div>
          </div>

          <hr style="margin:12px 0">

          <div style="margin-bottom:8px">
            Кол-во дней: <input id="daysCount" type="number" value="5" min="1" style="width:80px">
          </div>
          <button id="createPlanBtn">Авто-распределение</button>
        </div>
      </div>
    </div>

    <div style="margin-top:20px" id="daysContainer"></div>
  </div>
</div>

<script>
let plan = { PlanName: 'Новый план', Topics: [] };
const topicsList = document.getElementById('topicsList');
const planNameEl = document.getElementById('planName');
const statCount = document.getElementById('statCount');
const statMinutes = document.getElementById('statMinutes');
const statDoneMin = document.getElementById('statDoneMin');
const statPct = document.getElementById('statPct');
const filterType = document.getElementById('filterType');
const daysContainer = document.getElementById('daysContainer');
const daysCountEl = document.getElementById('daysCount');

function uid(){ return Math.random().toString(36).slice(2,9); }

function updateStats(){
  const total = plan.Topics.length;
  const totalMin = plan.Topics.reduce((s,t)=>s + Number(t.Minutes||0),0);
  const doneMin = plan.Topics.filter(t=>t.Done).reduce((s,t)=>s + Number(t.Minutes||0),0);
  const pct = totalMin? Math.round((doneMin/totalMin)*100) : 0;
  statCount.textContent = total;
  statMinutes.textContent = totalMin + ' мин';
  statDoneMin.textContent = doneMin + ' мин';
  statPct.textContent = pct + '%';
}

function renderTopics(){
  topicsList.innerHTML = '';
  const filter = filterType.value;
  const arr = plan.Topics.filter(t=>{
    if(filter==='all') return true;
    if(filter==='internal') return !!t.Internal;
    if(filter==='external') return !t.Internal;
    if(filter==='remaining') return !t.Done;
    return true;
  });
  arr.forEach(t=>{
    const el = document.createElement('div'); el.className='topic';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!t.Done;
    chk.addEventListener('change', ()=>{ t.Done = chk.checked; updateUI(); });
    const title = document.createElement('div'); title.className='title';
    title.innerHTML = `<div style="font-weight:600">${t.Title}</div>
      <div class="small">${t.Minutes} мин <span class="tag">${t.Internal? 'внутренние':'внешние'}</span></div>`;
    const selectDay = document.createElement('select');
    selectDay.innerHTML = `<option value="">Без дня</option>` + 
      Array.from({length:Number(daysCountEl.value)},(_,i)=>`<option value="${i+1}">День ${i+1}</option>`).join('');
    selectDay.value = t.Day || '';
    selectDay.onchange = ()=>{ t.Day = selectDay.value? Number(selectDay.value):null; renderDays(); };
    el.appendChild(chk); el.appendChild(title); el.appendChild(selectDay);
    topicsList.appendChild(el);
  });
}

function renderDays(){
  daysContainer.innerHTML = '';
  const count = Number(daysCountEl.value)||1;
  for(let d=1; d<=count; d++){
    const block = document.createElement('div'); block.className='day-block';

    // считаем прогресс по дню
    const dayTopics = plan.Topics.filter(t=>t.Day===d);
    const totalMin = dayTopics.reduce((s,t)=>s+Number(t.Minutes||0),0);
    const doneMin = dayTopics.filter(t=>t.Done).reduce((s,t)=>s+Number(t.Minutes||0),0);
    const pct = totalMin? Math.round(doneMin/totalMin*100):0;

    block.innerHTML = `<strong>День обучения ${d}</strong> — <span class="muted">${pct}% выполнено</span>`;

    if(dayTopics.length===0){ 
      block.innerHTML += '<div class="small muted">Нет тем</div>'; 
    }
    dayTopics.forEach(t=>{
      const row = document.createElement('div'); row.className='day-topic';
      const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!t.Done;
      chk.addEventListener('change', ()=>{ t.Done = chk.checked; updateUI(); });
      const label = document.createElement('div'); label.className='small';
      label.textContent = `${t.Title} — ${t.Minutes} мин — ${t.Internal?'внутренние':'внешние'}`;
      row.appendChild(chk); row.appendChild(label);
      block.appendChild(row);
    });
    daysContainer.appendChild(block);
  }
}

function updateUI(){
  planNameEl.value = plan.PlanName||'';
  renderTopics();
  renderDays();
  updateStats();
}

document.getElementById('addTopicBtn').onclick = ()=>{
  const title = document.getElementById('newTitle').value.trim();
  const minutes = Math.max(1, Number(document.getElementById('newMinutes').value)||10);
  const internal = document.getElementById('newInternal').checked;
  if(!title) return alert('Введите название темы');
  plan.Topics.push({Title:title, Minutes:minutes, Internal:internal, Done:false, id:uid(), Day:null});
  document.getElementById('newTitle').value=''; document.getElementById('newMinutes').value=''; document.getElementById('newInternal').checked=false;
  updateUI();
};

planNameEl.oninput = ()=>{ plan.PlanName = planNameEl.value; };
filterType.onchange = ()=> renderTopics();

document.getElementById('createPlanBtn').onclick = ()=>{
  const count = Number(daysCountEl.value)||1;
  let d=1;
  plan.Topics.forEach(t=>{ t.Day = d; d++; if(d>count) d=1; });
  updateUI();
};

document.getElementById('saveSessionBtn').onclick = ()=>{
  const blob = new Blob([JSON.stringify(plan,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='session.json'; a.click(); a.remove();
};
document.getElementById('loadSessionBtn').onclick = ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='.json';
  inp.onchange = e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
      try{ plan=JSON.parse(ev.target.result); updateUI(); }
      catch(e){ alert('Ошибка'); }
    };
    r.readAsText(f);
  };
  inp.click();
};
document.getElementById('uploadPlan').onchange = e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const obj=JSON.parse(ev.target.result);
      plan={ PlanName: obj.PlanName||'План', Topics:(obj.Topics||[]).map(x=>({Title:x.Title,Minutes:x.Minutes,Internal:!!x.Internal,Done:!!x.Done,id:uid(),Day:x.Day||null})) };
      updateUI();
    }catch(err){ alert('Ошибка JSON'); }
  };
  r.readAsText(f);
};

updateUI();
</script>
</body>
</html>
